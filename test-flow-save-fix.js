// Script para testar se o problema de salvamento foi resolvido
// Execute este script no console do navegador na p√°gina do Flow Builder

console.log('üß™ Testando corre√ß√£o do salvamento de flows...')

// Fun√ß√£o para testar o salvamento completo
async function testFlowSaveComplete() {
  try {
    console.log('üìã Iniciando teste completo de salvamento...')
    
    // Verificar se estamos na p√°gina correta
    if (!window.location.pathname.includes('/flow-builder')) {
      console.error('‚ùå N√£o estamos na p√°gina do Flow Builder')
      return
    }
    
    // Verificar se o flowBuilderService est√° dispon√≠vel
    if (typeof window.flowBuilderService === 'undefined') {
      console.error('‚ùå flowBuilderService n√£o est√° dispon√≠vel')
      return
    }
    
    // Verificar se o supabase est√° dispon√≠vel
    if (typeof window.supabase === 'undefined') {
      console.error('‚ùå Supabase n√£o est√° dispon√≠vel')
      return
    }
    
    console.log('‚úÖ Servi√ßos dispon√≠veis')
    
    // Verificar se o usu√°rio est√° autenticado
    const user = window.supabase.auth.user()
    if (!user) {
      console.error('‚ùå Usu√°rio n√£o est√° autenticado')
      return
    }
    
    console.log('‚úÖ Usu√°rio autenticado:', user.id)
    
    // Criar um flow de teste com m√∫ltiplos n√≥s
    const testFlow = {
      name: 'Teste Salvamento Completo',
      description: 'Teste para verificar salvamento de m√∫ltiplos n√≥s',
      userId: user.id,
      isActive: false,
      isTemplate: false,
      category: 'test',
      flowData: {
        nodes: [
          {
            id: 'trigger-1',
            type: 'trigger',
            position: { x: 100, y: 100 },
            config: { triggerType: 'manual' },
            data: {
              id: 'trigger-1',
              type: 'trigger',
              label: 'Trigger Manual',
              config: { triggerType: 'manual' },
              isActive: true
            },
            isActive: true,
            label: 'Trigger Manual',
            description: 'Trigger manual para teste'
          },
          {
            id: 'action-1',
            type: 'action',
            position: { x: 300, y: 100 },
            config: { actionType: 'log' },
            data: {
              id: 'action-1',
              type: 'action',
              label: 'Log Action',
              config: { actionType: 'log' },
              isActive: true
            },
            isActive: true,
            label: 'Log Action',
            description: 'A√ß√£o de log para teste'
          },
          {
            id: 'condition-1',
            type: 'condition',
            position: { x: 500, y: 100 },
            config: { conditionType: 'if' },
            data: {
              id: 'condition-1',
              type: 'condition',
              label: 'If Condition',
              config: { conditionType: 'if' },
              isActive: true
            },
            isActive: true,
            label: 'If Condition',
            description: 'Condi√ß√£o if para teste'
          }
        ],
        connections: [
          {
            id: 'edge-1',
            source: 'trigger-1',
            target: 'action-1',
            sourceHandle: 'output',
            targetHandle: 'input',
            condition: {}
          },
          {
            id: 'edge-2',
            source: 'action-1',
            target: 'condition-1',
            sourceHandle: 'output',
            targetHandle: 'input',
            condition: {}
          }
        ],
        variables: {},
        settings: {}
      },
      variables: {},
      settings: {
        timeout: 30000,
        retryAttempts: 3,
        retryDelay: 1000,
        errorHandling: 'stop',
        logging: 'errors'
      }
    }
    
    console.log('üìù Flow de teste criado com 3 n√≥s e 2 conex√µes')
    
    // Tentar criar o flow
    console.log('üíæ Tentando criar flow...')
    const createdFlow = await window.flowBuilderService.createFlow(testFlow)
    
    if (createdFlow) {
      console.log('‚úÖ Flow criado com sucesso:', createdFlow)
      
      // Verificar se os n√≥s foram salvos
      if (createdFlow.flowData && createdFlow.flowData.nodes) {
        console.log('‚úÖ N√≥s salvos:', createdFlow.flowData.nodes.length)
        console.log('üìã Detalhes dos n√≥s:', createdFlow.flowData.nodes.map(n => ({ id: n.id, type: n.type, label: n.label })))
        
        if (createdFlow.flowData.nodes.length === 3) {
          console.log('‚úÖ Todos os 3 n√≥s foram salvos corretamente')
        } else {
          console.error('‚ùå N√∫mero incorreto de n√≥s salvos:', createdFlow.flowData.nodes.length)
        }
      } else {
        console.error('‚ùå N√≥s n√£o foram salvos')
      }
      
      // Verificar se as conex√µes foram salvas
      if (createdFlow.flowData && createdFlow.flowData.connections) {
        console.log('‚úÖ Conex√µes salvas:', createdFlow.flowData.connections.length)
        console.log('üìã Detalhes das conex√µes:', createdFlow.flowData.connections.map(c => ({ id: c.id, source: c.source, target: c.target })))
        
        if (createdFlow.flowData.connections.length === 2) {
          console.log('‚úÖ Todas as 2 conex√µes foram salvas corretamente')
        } else {
          console.error('‚ùå N√∫mero incorreto de conex√µes salvas:', createdFlow.flowData.connections.length)
        }
      } else {
        console.error('‚ùå Conex√µes n√£o foram salvas')
      }
      
      // Tentar atualizar o flow com mais n√≥s
      console.log('üîÑ Adicionando mais n√≥s ao flow...')
      const updatedFlow = await window.flowBuilderService.updateFlow(createdFlow.id, {
        ...createdFlow,
        flowData: {
          ...createdFlow.flowData,
          nodes: [
            ...createdFlow.flowData.nodes,
            {
              id: 'action-2',
              type: 'action',
              position: { x: 700, y: 100 },
              config: { actionType: 'email' },
              data: {
                id: 'action-2',
                type: 'action',
                label: 'Email Action',
                config: { actionType: 'email' },
                isActive: true
              },
              isActive: true,
              label: 'Email Action',
              description: 'A√ß√£o de email para teste'
            }
          ],
          connections: [
            ...createdFlow.flowData.connections,
            {
              id: 'edge-3',
              source: 'condition-1',
              target: 'action-2',
              sourceHandle: 'output',
              targetHandle: 'input',
              condition: {}
            }
          ]
        }
      })
      
      if (updatedFlow) {
        console.log('‚úÖ Flow atualizado com sucesso:', updatedFlow)
        
        // Verificar se os novos n√≥s foram salvos
        if (updatedFlow.flowData && updatedFlow.flowData.nodes) {
          console.log('‚úÖ N√≥s ap√≥s atualiza√ß√£o:', updatedFlow.flowData.nodes.length)
          
          if (updatedFlow.flowData.nodes.length === 4) {
            console.log('‚úÖ Todos os 4 n√≥s foram salvos corretamente')
          } else {
            console.error('‚ùå N√∫mero incorreto de n√≥s ap√≥s atualiza√ß√£o:', updatedFlow.flowData.nodes.length)
          }
        }
        
        // Verificar se as novas conex√µes foram salvas
        if (updatedFlow.flowData && updatedFlow.flowData.connections) {
          console.log('‚úÖ Conex√µes ap√≥s atualiza√ß√£o:', updatedFlow.flowData.connections.length)
          
          if (updatedFlow.flowData.connections.length === 3) {
            console.log('‚úÖ Todas as 3 conex√µes foram salvas corretamente')
          } else {
            console.error('‚ùå N√∫mero incorreto de conex√µes ap√≥s atualiza√ß√£o:', updatedFlow.flowData.connections.length)
          }
        }
      } else {
        console.error('‚ùå Falha ao atualizar flow')
      }
      
      // Limpar o flow de teste
      console.log('üßπ Limpando flow de teste...')
      await window.flowBuilderService.deleteFlow(createdFlow.id)
      console.log('‚úÖ Flow de teste removido')
      
      return true
    } else {
      console.error('‚ùå Falha ao criar flow')
      return false
    }
    
  } catch (error) {
    console.error('‚ùå Erro durante o teste:', error)
    console.error('Stack trace:', error.stack)
    return false
  }
}

// Fun√ß√£o para verificar se o problema foi resolvido
function checkIfFixed() {
  try {
    console.log('üîç Verificando se o problema foi resolvido...')
    
    // Verificar se h√° n√≥s no canvas
    const nodes = document.querySelectorAll('.react-flow__node')
    console.log('üîó N√≥s vis√≠veis no canvas:', nodes.length)
    
    // Verificar se h√° conex√µes no canvas
    const edges = document.querySelectorAll('.react-flow__edge')
    console.log('üîó Conex√µes vis√≠veis no canvas:', edges.length)
    
    // Verificar se o bot√£o de salvar est√° dispon√≠vel
    const saveButton = document.querySelector('button[onclick*="handleSave"], button:has(svg[data-testid="save"])')
    console.log('üíæ Bot√£o de salvar encontrado:', !!saveButton)
    
    // Verificar se h√° erros no console
    const consoleErrors = window.consoleErrors || []
    console.log('‚ùå Erros no console:', consoleErrors.length)
    
    return {
      visibleNodes: nodes.length,
      visibleEdges: edges.length,
      saveButtonAvailable: !!saveButton,
      consoleErrors: consoleErrors.length
    }
  } catch (error) {
    console.error('‚ùå Erro ao verificar estado:', error)
    return null
  }
}

// Fun√ß√£o para testar o salvamento manual
async function testManualSave() {
  try {
    console.log('üñ±Ô∏è Testando salvamento manual...')
    
    // Simular clique no bot√£o de salvar
    const saveButton = document.querySelector('button[onclick*="handleSave"], button:has(svg[data-testid="save"])')
    if (saveButton) {
      console.log('üñ±Ô∏è Clicando no bot√£o de salvar...')
      saveButton.click()
      
      // Aguardar um pouco para ver se h√° erros
      await new Promise(resolve => setTimeout(resolve, 2000))
      
      console.log('‚úÖ Salvamento manual testado')
      return true
    } else {
      console.error('‚ùå Bot√£o de salvar n√£o encontrado')
      return false
    }
  } catch (error) {
    console.error('‚ùå Erro ao testar salvamento manual:', error)
    return false
  }
}

// Expor fun√ß√µes para uso manual
window.testFlowSaveFix = {
  testFlowSaveComplete,
  checkIfFixed,
  testManualSave
}

console.log('‚úÖ Teste de corre√ß√£o do Flow Builder carregado!')
console.log('üí° Use window.testFlowSaveFix.testFlowSaveComplete() para teste completo')
console.log('üí° Use window.testFlowSaveFix.checkIfFixed() para verificar estado')
console.log('üí° Use window.testFlowSaveFix.testManualSave() para testar salvamento manual') 